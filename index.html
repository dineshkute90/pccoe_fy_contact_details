<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCCOE Student Contact Search</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --pccoe-blue: #1a237e;
            --pccoe-red: #d32f2f;
            --pccoe-green: #2e7d32;
            --pccoe-gold: #ff9800;
            --pccoe-light: #e8eaf6;
        }
        
        body {
            background-color: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .login-container {
            max-width: 450px;
            width: 100%;
            padding: 20px;
        }
        
        .login-box {
            background: white;
            border-radius: 15px;
            padding: 2.5rem;
            box-shadow: 0 10px 30px rgba(26, 35, 126, 0.2);
            border-top: 5px solid var(--pccoe-blue);
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--pccoe-blue);
        }
        
        .app-title {
            color: var(--pccoe-blue);
            text-align: center;
            margin: 1.5rem 0;
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .app-title span {
            color: var(--pccoe-red);
        }
        
        .login-btn {
            background: var(--pccoe-green);
            border: none;
            padding: 12px;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
            color: white;
            letter-spacing: 0.5px;
            border-radius: 8px;
        }
        
        .login-btn:hover {
            background: #1b5e20;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 125, 50, 0.3);
            color: white;
        }
        
        .main-container {
            display: none;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .directory-header {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: white;
            padding: 0.8rem 1.2rem;
            border-radius: 10px;
            margin: 1.5rem 0;
            position: relative;
            box-shadow: 0 4px 12px rgba(26, 35, 126, 0.2);
            border-left: 6px solid #ff9800;
            border-right: 6px solid #ff9800;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 100px;
        }
        
        .header-content {
            flex: 1;
            text-align: center;
            padding: 0 15px;
        }
        
        .directory-header h2 {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0.3rem 0;
            color: white;
        }
        
        .directory-header h2 span {
            color: #ffcc80;
        }
        
        .directory-header p {
            margin: 0.2rem 0;
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .academic-year {
            background: rgba(255, 152, 0, 0.9);
            color: #1a237e;
            padding: 0.3rem 1.5rem;
            border-radius: 20px;
            font-weight: 700;
            display: inline-block;
            margin-top: 0.5rem;
            font-size: 1.1rem;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 20px;
            border-radius: 5px;
            transition: all 0.3s;
            font-weight: 500;
            margin-left: auto;
            white-space: nowrap;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            height: 100%;
        }
        
        .header-logo {
            height: 90px;
            width: auto;
            object-fit: contain;
            padding: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .login-logo-img {
            height: 80px;
            width: auto;
            margin-bottom: 15px;
        }
        
        .search-box {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        
        .search-btn {
            background: var(--pccoe-blue);
            border: none;
            padding: 8px 20px;
            transition: all 0.3s;
        }
        
        .search-btn:hover {
            background: #283593;
            transform: translateY(-1px);
        }
        
        .data-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .table th {
            background-color: var(--pccoe-blue);
            color: white;
            border: none;
            padding: 12px 15px;
        }
        
        .table td {
            padding: 10px 15px;
            vertical-align: middle;
        }
        
        .highlight {
            background-color: #fff9c4 !important;
        }
        
        .stats-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 4px solid var(--pccoe-blue);
            margin-bottom: 1rem;
        }
        
        .footer {
            margin-top: auto;
            padding: 1rem;
            background-color: var(--pccoe-blue);
            color: white;
            text-align: center;
            border-radius: 8px;
            margin-top: 2rem;
        }
        
        .badge-prn {
            background-color: #5c6bc0;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85rem;
        }
        
        #loading {
            text-align: center;
            padding: 20px;
        }
        
        .action-btn {
            padding: 4px 8px;
            margin: 0 2px;
            font-size: 0.8rem;
        }
        
        .dataTables_wrapper {
            padding: 0 10px;
        }
        
        .mobile-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        
        .mobile-text {
            flex-grow: 1;
        }
        
        .copy-icon-btn {
            background-color: transparent;
            border: 1px solid #6c757d;
            color: #6c757d;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .copy-icon-btn:hover {
            background-color: #6c757d;
            color: white;
            transform: scale(1.05);
        }
        
        .copy-icon-btn i {
            font-size: 0.8rem;
        }
        
        .email-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        
        .email-text {
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .error-message {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 5px;
            display: none;
        }
        
        .login-error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            display: none;
        }
        
        .multi-search-container {
            border-top: 1px dashed #dee2e6;
            padding-top: 1rem;
            margin-top: 1rem;
        }
        
        .multi-prn-help {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        
        .prn-badge {
            background-color: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85rem;
            margin-right: 0.25rem;
            margin-bottom: 0.25rem;
            display: inline-block;
        }
        
        .export-btn {
            background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);
            border: none;
            color: white;
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .export-btn:hover {
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(46, 125, 50, 0.3);
            color: white;
        }
        
        .export-btn:disabled {
            background: #6c757d;
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .export-options {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .export-option-label {
            font-weight: 600;
            margin-bottom: 10px;
            color: #1a237e;
        }
        
        .search-results-header {
            background: #e8eaf6;
            border-left: 4px solid var(--pccoe-blue);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .results-count {
            font-weight: 600;
            color: var(--pccoe-blue);
        }
        
        .no-results-message {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        
        /* Hide the "Show entries" dropdown */
        .dataTables_length {
            display: none !important;
        }
        
        .paste-info {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        
        .admin-features {
            background: #fff3e0;
            border-left: 4px solid var(--pccoe-gold);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .admin-badge {
            background: linear-gradient(135deg, var(--pccoe-gold) 0%, #ffb74d 100%);
            color: #1a237e;
            padding: 3px 10px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        
        .admin-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .admin-btn {
            background: linear-gradient(135deg, var(--pccoe-gold) 0%, #ffb74d 100%);
            border: none;
            color: #1a237e;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .admin-btn:hover {
            background: linear-gradient(135deg, #f57c00 0%, var(--pccoe-gold) 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3);
            color: #1a237e;
        }
        
        .edit-btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .edit-btn:hover {
            background: #0d8bf2;
            transform: scale(1.05);
        }
        
        .delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .delete-btn:hover {
            background: #e53935;
            transform: scale(1.05);
        }
        
        .modal-content {
            border-radius: 10px;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            background: var(--pccoe-blue);
            color: white;
            border-radius: 10px 10px 0 0;
        }
        
        .modal-title {
            font-weight: 600;
        }
        
        .form-label {
            font-weight: 500;
            color: #1a237e;
        }
        
        /* Email-specific styles */
        .email-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .send-email-btn {
            background-color: #34a853;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 3px;
            white-space: nowrap;
        }
        
        .send-email-btn:hover {
            background-color: #2e8b47;
            transform: scale(1.05);
        }
        
        .send-email-btn i {
            font-size: 0.7rem;
        }
        
        .bulk-email-btn {
            background: linear-gradient(135deg, #ea4335 0%, #fbbc05 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .bulk-email-btn:hover {
            background: linear-gradient(135deg, #d62516 0%, #e6a700 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(234, 67, 53, 0.3);
        }
        
        .template-badge {
            background-color: #e8f0fe;
            color: #1967d2;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            margin-left: 5px;
            font-weight: 500;
        }
        
        /* Email Modal Styles */
        .email-modal-body {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .template-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .template-preview h6 {
            color: #1a237e;
            border-bottom: 2px solid #1a237e;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        
        .template-item {
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .template-item:hover {
            background-color: #e8eaf6;
            border-color: #1a237e;
        }
        
        .template-item.active {
            background-color: #e8eaf6;
            border-color: #1a237e;
            border-left: 4px solid #1a237e;
        }
        
        .template-subject {
            font-weight: 600;
            color: #1a237e;
            margin-bottom: 5px;
        }
        
        .template-content {
            font-size: 0.85rem;
            color: #495057;
            white-space: pre-line;
        }
        
        /* Progress indicator */
        .email-progress {
            display: none;
            margin-top: 15px;
        }
        
        .progress-bar {
            height: 8px;
            background: linear-gradient(90deg, #34a853, #4285f4);
        }
        
        /* Checkbox styles */
        .checkbox-cell {
            width: 40px;
            text-align: center;
        }
        
        .student-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .select-all-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .selection-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #dee2e6;
        }
        
        .selection-info {
            font-weight: 600;
            color: #1a237e;
            margin-right: 15px;
        }
        
        .selection-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .email-templates-bottom {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #2e7d32;
        }
        
        .email-templates-bottom h6 {
            color: #1a237e;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .template-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .template-btn {
            background: #34a853;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .template-btn:hover {
            background: #2e8b47;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(46, 125, 50, 0.3);
        }
        
        .template-btn i {
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .directory-header {
                flex-direction: column;
                padding: 1rem;
                text-align: center;
            }
            
            .header-logo {
                height: 60px;
                margin-bottom: 10px;
            }
            
            .header-content {
                padding: 10px 0;
            }
            
            .directory-header h2 {
                font-size: 1.5rem;
            }
            
            .directory-header p {
                font-size: 1rem;
            }
            
            .logout-btn {
                margin-top: 10px;
                margin-left: 0;
            }
            
            .search-results-header {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .admin-controls {
                flex-direction: column;
            }
            
            .email-actions {
                flex-wrap: wrap;
            }
            
            .selection-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            
            .template-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div class="login-container" id="loginSection">
        <div class="login-box">
            <div class="login-logo">
                <!-- PCCOE Logo -->
                <img src="https://raw.githubusercontent.com/dineshkute90/pccoe_fy_contact_details/main/pccoe_logo.png" 
                     alt="PCCOE Logo" 
                     class="login-logo-img">
                <h2>PCCOE Student Directory</h2>
                <p class="text-muted mb-0">Department of Applied Sciences & Humanities</p>
            </div>
            
            <div class="login-error" id="loginError">
                <i class="fas fa-exclamation-circle"></i> Invalid username or password
            </div>
            
            <form id="loginForm">
                <div class="mb-3">
                    <label for="username" class="form-label">
                        <i class="fas fa-user"></i> Username
                    </label>
                    <input type="text" class="form-control" id="username" 
                           placeholder="Enter username" required>
                </div>
                
                <div class="mb-3">
                    <label for="password" class="form-label">
                        <i class="fas fa-lock"></i> Password
                    </label>
                    <input type="password" class="form-control" id="password" 
                           placeholder="Enter password" required>
                </div>
                
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="rememberMe">
                    <label class="form-check-label" for="rememberMe">Remember me</label>
                </div>
                
                <button type="submit" class="btn login-btn">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                
                <div class="text-center mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> Admin: Mr. Dinesh Kute
                    </small>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Application Section -->
    <div class="main-container" id="mainSection">
        <div class="directory-header">
            <!-- PCCOE Logo in header -->
            <div class="logo-container">
                <img src="https://raw.githubusercontent.com/dineshkute90/pccoe_fy_contact_details/main/pccoe_logo.png" 
                     alt="PCCOE Logo" 
                     class="header-logo">
            </div>
            
            <!-- Center Content -->
            <div class="header-content">
                <h1><i class="fas fa-graduation-cap"></i> PCCOE Student Directory</h1>
                <p>Department of Applied Sciences & Humanities</p>
                <p>2025-26</p>
            </div>
            
            <!-- Logout Button -->
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
        
        <!-- Admin Features Section (Visible only to admin) -->
        <div class="admin-features" id="adminFeatures" style="display: none;">
            <div class="d-flex align-items-center mb-3">
                <h5 class="mb-0"><i class="fas fa-user-shield"></i> Admin Controls</h5>
                <span class="admin-badge">ADMIN MODE</span>
            </div>
            <div class="admin-controls">
                <button class="admin-btn" onclick="showAllStudents()">
                    <i class="fas fa-list"></i> View All Students
                </button>
                <button class="admin-btn" onclick="exportAllData()">
                    <i class="fas fa-download"></i> Download Entire Database
                </button>
                <button class="admin-btn" onclick="showAddStudentModal()">
                    <i class="fas fa-user-plus"></i> Add New Student
                </button>
                <button class="admin-btn" onclick="openBulkEmailModal()">
                    <i class="fas fa-envelope-open-text"></i> Send Bulk Email
                </button>
                <button class="admin-btn" onclick="clearSearch()">
                    <i class="fas fa-times"></i> Clear All Filters
                </button>
            </div>
            <small class="text-muted">
                <i class="fas fa-info-circle"></i> Admin privileges: Edit/Delete students, View all data, Export complete database
            </small>
        </div>

        <!-- Search Section -->
        <div class="search-box">
            <!-- Single Search Section -->
            <div class="row g-3">
                <div class="col-md-5">
                    <label for="searchPRN" class="form-label">
                        <i class="fas fa-id-card"></i> Search by PRN (Single)
                    </label>
                    <input type="text" class="form-control" id="searchPRN" 
                           placeholder="e.g., 123B1G035">
                </div>
                <div class="col-md-5">
                    <label for="searchName" class="form-label">
                        <i class="fas fa-user"></i> Search by Name
                    </label>
                    <input type="text" class="form-control" id="searchName" 
                           placeholder="Enter student name">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-primary search-btn w-100" onclick="searchTable()">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
            </div>
            
            <!-- Multi-PRN Search Section -->
            <div class="multi-search-container">
                <div class="row g-3">
                    <div class="col-md-10">
                        <label for="multiPRNSearch" class="form-label">
                            <i class="fas fa-list-check"></i> Search Multiple PRNs
                        </label>
                        <textarea class="form-control" id="multiPRNSearch" 
                               placeholder="Paste PRNs from Excel or enter separated by commas, spaces, or semicolons&#10;e.g., 123B1G035, 123B1G036 123B1G037; 123B1G038"
                               rows="3"></textarea>
                        <div class="multi-prn-help">
                            <i class="fas fa-info-circle"></i> Supports: commas (,), spaces, semicolons (;), tabs, or new lines
                        </div>
                        <div class="paste-info">
                            <i class="fas fa-paste"></i> You can directly paste a column of PRNs from Excel
                        </div>
                        <div id="prnBadgesContainer" class="mt-2" style="display: none;">
                            <small>Searching for:</small>
                            <div id="prnBadges"></div>
                        </div>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-success w-100" onclick="searchMultiplePRNs()">
                            <i class="fas fa-magnifying-glass"></i> Search PRNs
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Export Options -->
            <div class="export-options">
                <div class="row g-3">
                    <div class="col-md-6">
                        <button class="btn export-btn w-100" onclick="exportSearchResults()" id="exportSearchBtn">
                            <i class="fas fa-file-excel"></i> Export Search Results
                        </button>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="exportFormat">
                            <option value="xlsx">Excel (.xlsx)</option>
                            <option value="csv">CSV (.csv)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="includeTimestamp" checked>
                            <label class="form-check-label" for="includeTimestamp">
                                Include timestamp in filename
                            </label>
                        </div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> Note: Only exports current search results for data security
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="row g-2 mt-3">
                <div class="col-md-4">
                    <button class="btn btn-outline-secondary w-100" onclick="clearSearch()">
                        <i class="fas fa-times"></i> Clear Search
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-outline-info w-100" onclick="loadCSVData()">
                        <i class="fas fa-sync"></i> Reload Data
                    </button>
                </div>
                <div class="col-md-4">
                    <select class="form-select" id="filterColumn" onchange="searchTable()">
                        <option value="all">Search in All Columns</option>
                        <option value="1">PRN</option>
                        <option value="2">Student Name</option>
                        <option value="3">Student Mobile</option>
                        <option value="4">Parent Mobile</option>
                        <option value="5">Email</option>
                        <option value="6">Offering Year</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="row">
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-users"></i>
                    <h5 id="totalStudents">0</h5>
                    <small>Total Students</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-database"></i>
                    <h5 id="dataStatus">Loading...</h5>
                    <small>Data Status</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-search"></i>
                    <h5 id="searchResults">0</h5>
                    <small>Search Results</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-download"></i>
                    <h5 id="exportCount">0</h5>
                    <small>Ready to Export</small>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading student data from CSV...</p>
        </div>

        <!-- No Results Message -->
        <div class="no-results-message" id="noResultsMessage">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <h5>Search Students</h5>
            <p class="text-muted">Enter search criteria above to find students.</p>
            <p class="text-muted small">Search results will be displayed here and available for export.</p>
        </div>

        <!-- Search Results Header -->
        <div class="search-results-header" id="searchResultsHeader" style="display: none;">
            <div>
                <h6 class="mb-0"><i class="fas fa-search me-2"></i>Search Results</h6>
                <p class="mb-0 mt-1">
                    Found <span class="results-count" id="resultsCount">0</span> student(s) 
                    <span id="searchCriteria" class="text-muted"></span>
                </p>
            </div>
            <button class="btn export-btn" onclick="exportSearchResults()" id="exportHeaderBtn">
                <i class="fas fa-file-excel"></i> Export Results
            </button>
        </div>

        <!-- Data Table -->
        <div class="data-table" id="dataTableContainer">
            <table id="studentTable" class="table table-striped" style="width:100%">
                <thead>
                    <tr>
                        <th class="checkbox-cell">
                            <input type="checkbox" class="select-all-checkbox" id="selectAllCheckbox" title="Select All">
                        </th>
                        <th>Sr. No.</th>
                        <th>Offering Year</th>
                        <th>PRN</th>
                        <th>Student Name</th>
                        <th>Student Mobile</th>
                        <th>Parent Mobile</th>
                        <th>Email ID</th>
                        <th id="actionColumnHeader" style="display: none;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be loaded by DataTable -->
                </tbody>
            </table>
        </div>

        <!-- Selection Controls -->
        <div class="selection-controls" id="selectionControls" style="display: none;">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div class="d-flex align-items-center mb-2 mb-md-0">
                    <span class="selection-info">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <span id="selectedCount">0</span> student(s) selected
                    </span>
                </div>
                <div class="selection-buttons">
                    <button class="btn btn-outline-primary" onclick="selectAll()">
                        <i class="fas fa-check-square"></i> Select All
                    </button>
                    <button class="btn btn-outline-secondary" onclick="deselectAll()">
                        <i class="fas fa-times-circle"></i> Clear Selection
                    </button>
                    <button class="btn btn-success" onclick="openBulkEmailModal()">
                        <i class="fas fa-envelope"></i> Send Email to Selected
                    </button>
                </div>
            </div>
        </div>

        <!-- Email Templates at Bottom -->
        <div class="email-templates-bottom" id="emailTemplatesBottom" style="display: none;">
            <h6><i class="fas fa-mail-bulk me-2"></i>Quick Email Templates</h6>
            <div class="template-buttons">
                <button class="template-btn" onclick="sendSelectedTemplateEmail('defaulter')">
                    <i class="fas fa-exclamation-circle"></i> Defaulter Notice
                </button>
                <button class="template-btn" onclick="sendSelectedTemplateEmail('exam_performance')">
                    <i class="fas fa-file-alt"></i> Exam Performance
                </button>
                <button class="template-btn" onclick="sendSelectedTemplateEmail('attendance')">
                    <i class="fas fa-calendar-check"></i> Attendance Alert
                </button>
                <button class="template-btn" onclick="sendSelectedTemplateEmail('exam_schedule')">
                    <i class="fas fa-calendar-alt"></i> Exam Schedule
                </button>
                <button class="template-btn" onclick="sendSelectedTemplateEmail('parent_meeting')">
                    <i class="fas fa-users"></i> Parent Meeting
                </button>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p class="mb-1">
                <i class="fas fa-laptop-code"></i> PCCOE Student Directory developed by Mr. Dinesh Kute
            </p>
            <small>CSV File: contact_testing_csv.csv | Updated: <span id="currentDate"></span></small>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div class="modal fade" id="addStudentModal" tabindex="-1" aria-labelledby="addStudentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addStudentModalLabel">
                        <i class="fas fa-user-plus"></i> Add New Student
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addStudentForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="addPRN" class="form-label">PRN *</label>
                                <input type="text" class="form-control" id="addPRN" required>
                            </div>
                            <div class="col-md-6">
                                <label for="addName" class="form-label">Student Name *</label>
                                <input type="text" class="form-control" id="addName" required>
                            </div>
                            <div class="col-md-6">
                                <label for="addOfferingYear" class="form-label">Offering Year</label>
                                <input type="text" class="form-control" id="addOfferingYear" value="2025-26">
                            </div>
                            <div class="col-md-6">
                                <label for="addStudentMobile" class="form-label">Student Mobile *</label>
                                <input type="tel" class="form-control" id="addStudentMobile" required>
                            </div>
                            <div class="col-md-6">
                                <label for="addParentMobile" class="form-label">Parent Mobile</label>
                                <input type="tel" class="form-control" id="addParentMobile">
                            </div>
                            <div class="col-md-6">
                                <label for="addEmail" class="form-label">Email ID *</label>
                                <input type="email" class="form-control" id="addEmail" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="addNewStudent()">
                        <i class="fas fa-save"></i> Save Student
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div class="modal fade" id="editStudentModal" tabindex="-1" aria-labelledby="editStudentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editStudentModalLabel">
                        <i class="fas fa-edit"></i> Edit Student Information
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editStudentForm">
                        <input type="hidden" id="editStudentIndex">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="editPRN" class="form-label">PRN *</label>
                                <input type="text" class="form-control" id="editPRN" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editName" class="form-label">Student Name *</label>
                                <input type="text" class="form-control" id="editName" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editOfferingYear" class="form-label">Offering Year</label>
                                <input type="text" class="form-control" id="editOfferingYear">
                            </div>
                            <div class="col-md-6">
                                <label for="editStudentMobile" class="form-label">Student Mobile *</label>
                                <input type="tel" class="form-control" id="editStudentMobile" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editParentMobile" class="form-label">Parent Mobile</label>
                                <input type="tel" class="form-control" id="editParentMobile">
                            </div>
                            <div class="col-md-6">
                                <label for="editEmail" class="form-label">Email ID *</label>
                                <input type="email" class="form-control" id="editEmail" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="deleteCurrentStudent()">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveStudentChanges()">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Email Modal -->
    <div class="modal fade" id="bulkEmailModal" tabindex="-1" aria-labelledby="bulkEmailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #ea4335 0%, #fbbc05 100%); color: white;">
                    <h5 class="modal-title" id="bulkEmailModalLabel">
                        <i class="fas fa-envelope"></i> Send Bulk Email
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body email-modal-body">
                    <div class="mb-3">
                        <label class="form-label">Email Template</label>
                        <div class="template-preview">
                            <h6>Selected Template Preview</h6>
                            <div id="templatePreview">
                                <p class="text-muted">Select a template to preview</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Choose Template</label>
                        <div class="template-list" id="templateList">
                            <!-- Templates will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Selected Students</label>
                        <div class="alert alert-info">
                            <i class="fas fa-users"></i> 
                            <span id="selectedStudentsCount">0</span> student(s) selected for email
                        </div>
                        <div id="selectedStudentsEmails" class="small text-muted mt-2">
                            <!-- Emails will be listed here -->
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        <strong>Note:</strong> This will open Gmail in separate tabs for each student. 
                        You may need to allow popups for this site.
                    </div>
                    
                    <!-- Progress indicator -->
                    <div class="email-progress" id="emailProgress">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Sending emails...</span>
                            <span id="emailProgressText">0/0</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="emailProgressBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="sendBulkEmails()" id="sendBulkEmailsBtn">
                        <i class="fas fa-paper-plane"></i> Send Emails
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // Login credentials
        const VALID_CREDENTIALS = {
            'pccoeash': 'ashpccoe@2025',  // Regular user
            'admin': 'pccoe@admin'        // Admin user
        };
        
        let dataTable = null;
        let allStudents = [];
        let isLoggedIn = false;
        let currentSearchResults = [];
        let lastSearchCriteria = '';
        let isAdmin = false;
        let editModal = null;
        let addModal = null;
        let selectedStudentIndices = new Set(); // Store indices of selected students

        // Email Templates
        const EMAIL_TEMPLATES = {
            'defaulter': {
                name: 'Defaulter Student Notice',
                subject: 'Important Notice Regarding Your Academic Standing - PCCOE',
                body: `Dear [Student Name],

This is regarding your academic performance in the current semester. Our records indicate that you are falling behind in the following areas:

- Attendance requirements
- Assignment submissions
- Internal assessments

You are requested to meet your faculty advisor immediately to discuss your academic progress and create a plan for improvement.

Please bring this to the attention of your parents/guardians as well.

PRN: [PRN]
Student Name: [Student Name]

Best regards,
Department of Applied Sciences & Humanities
PCCOE, Pune`
            },
            'exam_performance': {
                name: 'Exam Performance Review',
                subject: 'Discussion on Your Recent Exam Performance - PCCOE',
                body: `Dear [Student Name],

This email is to discuss your performance in the recent Summative Assessments. Our analysis shows room for improvement in your scores.

Key Observations:
- Below-average performance in recent exams
- Need for focused preparation
- Regular revision required

We recommend that you:
1. Meet with your subject faculty for guidance
2. Join remedial classes if available
3. Follow a structured study schedule

We believe with proper guidance and effort, you can significantly improve your performance.

PRN: [PRN]
Student Name: [Student Name]

Sincerely,
Examination Cell
PCCOE, Pune`
            },
            'attendance': {
                name: 'Low Attendance Alert',
                subject: 'Urgent: Low Attendance Alert - PCCOE',
                body: `Dear [Student Name],

This is to inform you that your attendance percentage has fallen below the required minimum (75%) for the current semester.

Current Attendance: [Attendance]%
Required Minimum: 75%

As per university norms, students with less than 75% attendance may be debarred from appearing for the end-semester examinations.

Immediate Actions Required:
1. Start attending all classes regularly
2. Submit leave applications for any absences with valid reasons
3. Meet your class coordinator to discuss this matter

Please ensure regular attendance henceforth to avoid any academic consequences.

PRN: [PRN]
Student Name: [Student Name]

Regards,
Department of Applied Sciences & Humanities
PCCOE, Pune`
            },
            'exam_schedule': {
                name: 'SA Exam Schedule',
                subject: 'Summative Assessment (SA) Examination Schedule - PCCOE',
                body: `Dear Student,

Please find below the schedule for the upcoming Summative Assessment (SA) Examinations:

**Exam Schedule:**
- Date: [Date Range]
- Time: As per seating arrangement
- Venue: PCCOE Examination Halls

**Important Guidelines:**
1. Carry your college ID card and hall ticket
2. Reach the examination center 30 minutes before the exam
3. Follow all examination rules and regulations
4. Electronic devices are strictly prohibited

Seating arrangement will be displayed on the notice boards one week before the exams.

For any queries, please contact the examination cell.

PRN: [PRN]
Student Name: [Student Name]

Best wishes,
Examination Cell
PCCOE, Pune`
            },
            'parent_meeting': {
                name: 'Parent-Teacher Meeting',
                subject: 'Invitation for Parent-Teacher Meeting - PCCOE',
                body: `Respected Parents,

You are cordially invited to attend the Parent-Teacher Meeting scheduled as per details below:

**Meeting Details:**
- Date: [Date]
- Time: [Time]
- Venue: PCCOE Campus, Department of Applied Sciences & Humanities

**Agenda:**
1. Discussion of your ward's academic performance
2. Attendance and behavioral aspects
3. Future planning and guidance
4. One-on-one interaction with faculty

Your presence is highly valued and will help us work together for the betterment of your ward's academic journey.

Student Details:
PRN: [PRN]
Student Name: [Student Name]

We look forward to your participation.

Warm regards,
Department of Applied Sciences & Humanities
PCCOE, Pune`
            }
        };

        // Check if user is already logged in
        function checkLoginStatus() {
            const savedLogin = localStorage.getItem('pccoeLogin');
            if (savedLogin) {
                const loginData = JSON.parse(savedLogin);
                if (loginData.loggedIn && loginData.expiry > Date.now()) {
                    isLoggedIn = true;
                    isAdmin = loginData.isAdmin || false;
                    showMainApp();
                }
            }
        }

        // Handle login
        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            const loginError = document.getElementById('loginError');
            
            // Clear previous error
            loginError.style.display = 'none';
            
            // Validate credentials
            if (VALID_CREDENTIALS[username] && VALID_CREDENTIALS[username] === password) {
                isLoggedIn = true;
                isAdmin = (username === 'admin');
                
                // Save login if "Remember me" is checked
                if (rememberMe) {
                    const loginData = {
                        loggedIn: true,
                        isAdmin: isAdmin,
                        expiry: Date.now() + (7 * 24 * 60 * 60 * 1000) // 7 days
                    };
                    localStorage.setItem('pccoeLogin', JSON.stringify(loginData));
                } else {
                    // Session only
                    sessionStorage.setItem('pccoeSession', JSON.stringify({ loggedIn: true, isAdmin: isAdmin }));
                }
                
                showMainApp();
            } else {
                loginError.style.display = 'block';
                document.getElementById('password').value = '';
            }
        }

        // Logout function
        function logout() {
            isLoggedIn = false;
            isAdmin = false;
            localStorage.removeItem('pccoeLogin');
            sessionStorage.removeItem('pccoeSession');
            selectedStudentIndices.clear();
            showLogin();
        }

        // Show login screen
        function showLogin() {
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('mainSection').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('username').focus();
        }

        // Show main application
        function showMainApp() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainSection').style.display = 'block';
            
            // Set current date
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
            
            // Show/hide admin features
            if (isAdmin) {
                document.getElementById('adminFeatures').style.display = 'block';
            } else {
                document.getElementById('adminFeatures').style.display = 'none';
            }
            
            // Hide elements initially
            document.getElementById('noResultsMessage').style.display = 'block';
            document.getElementById('searchResultsHeader').style.display = 'none';
            document.getElementById('selectionControls').style.display = 'none';
            document.getElementById('emailTemplatesBottom').style.display = 'none';
            
            // Initialize modals
            editModal = new bootstrap.Modal(document.getElementById('editStudentModal'));
            addModal = new bootstrap.Modal(document.getElementById('addStudentModal'));
            
            // Clear selection
            selectedStudentIndices.clear();
            
            // Load CSV data
            loadCSVData();
        }

        // Initialize DataTable
        function initDataTable(data) {
            if (dataTable) {
                dataTable.destroy();
                $('#studentTable').empty();
            }

            // Show/hide action column based on admin status
            const actionColumn = isAdmin ? {
                data: null,
                orderable: false,
                render: function(data, type, row, meta) {
                    return `
                        <button class="edit-btn" onclick="editStudent(${meta.row})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-btn" onclick="deleteStudent(${meta.row})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                }
            } : null;

            const columns = [
                {
                    data: null,
                    orderable: false,
                    className: 'checkbox-cell',
                    render: function(data, type, row, meta) {
                        const isChecked = selectedStudentIndices.has(meta.row) ? 'checked' : '';
                        return `<input type="checkbox" class="student-checkbox" data-index="${meta.row}" ${isChecked} onchange="toggleStudentSelection(${meta.row}, this.checked)">`;
                    }
                },
                { 
                    data: null,
                    render: function(data, type, row, meta) {
                        return meta.row + 1;
                    }
                },
                { 
                    data: 'offering_year',
                    render: function(data) {
                        return data || '2022-2025';
                    }
                },
                { 
                    data: 'prn',
                    render: function(data) {
                        return `<span class="badge-prn">${data}</span>`;
                    }
                },
                { data: 'name' },
                { 
                    data: 'student_mobile',
                    render: function(data) {
                        return `
                            <div class="mobile-container">
                                <div class="mobile-text">
                                    <i class="fas fa-phone text-success me-1"></i>${data}
                                </div>
                                <button class="copy-icon-btn" onclick="copyToClipboard('${data}', 'Student mobile number')" title="Copy Student Mobile">
                                    <i class="far fa-copy"></i>
                                </button>
                            </div>
                        `;
                    }
                },
                { 
                    data: 'parent_mobile',
                    render: function(data) {
                        return `
                            <div class="mobile-container">
                                <div class="mobile-text">
                                    <i class="fas fa-user-friends text-primary me-1"></i>${data}
                                </div>
                                <button class="copy-icon-btn" onclick="copyToClipboard('${data}', 'Parent mobile number')" title="Copy Parent Mobile">
                                    <i class="far fa-copy"></i>
                                </button>
                            </div>
                        `;
                    }
                },
                { 
                    data: 'email',
                    render: function(data, type, row, meta) {
                        const email = data || '';
                        const studentName = row.name || '';
                        const prn = row.prn || '';
                        
                        return `
                            <div class="email-container">
                                <div class="email-text">
                                    <i class="fas fa-envelope text-danger me-1"></i>${email}
                                </div>
                                <div class="d-flex gap-1">
                                    <button class="copy-icon-btn" onclick="copyToClipboard('${email}', 'Email address')" title="Copy Email">
                                        <i class="far fa-copy"></i>
                                    </button>
                                    <button class="send-email-btn" onclick="sendSingleEmail('${email}', '${studentName}', '${prn}')" title="Send Email">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                }
            ];

            // Add action column for admin
            if (actionColumn) {
                columns.push(actionColumn);
                document.getElementById('actionColumnHeader').style.display = '';
            } else {
                document.getElementById('actionColumnHeader').style.display = 'none';
            }

            dataTable = $('#studentTable').DataTable({
                data: data,
                columns: columns,
                pageLength: 10,
                lengthMenu: [], // Empty array to hide the "Show entries" dropdown
                language: {
                    search: "Search in results:",
                    info: "Showing _START_ to _END_ of _TOTAL_ entries",
                    infoEmpty: "No entries found",
                    infoFiltered: "(filtered from _MAX_ total entries)"
                },
                drawCallback: function() {
                    // Update export count after each draw
                    updateExportCount();
                    updateCurrentSearchResults();
                    updateSelectionDisplay();
                    updateSelectAllCheckbox();
                }
            });

            // Add event listener for select all checkbox
            document.getElementById('selectAllCheckbox').addEventListener('change', function() {
                selectAllVisible(this.checked);
            });

            // Update statistics
            updateTotalCount();
            updateExportCount();
            updateSelectionDisplay();
        }

        // Toggle student selection
        function toggleStudentSelection(index, isChecked) {
            if (isChecked) {
                selectedStudentIndices.add(index);
            } else {
                selectedStudentIndices.delete(index);
            }
            updateSelectionDisplay();
            updateSelectAllCheckbox();
        }

        // Select all visible students
        function selectAllVisible(select) {
            const visibleIndices = dataTable.rows({ search: 'applied' }).indexes().toArray();
            
            if (select) {
                visibleIndices.forEach(index => selectedStudentIndices.add(index));
            } else {
                visibleIndices.forEach(index => selectedStudentIndices.delete(index));
            }
            
            // Update checkboxes in table
            dataTable.rows({ search: 'applied' }).every(function() {
                const rowIndex = this.index();
                const checkbox = $(this.node()).find('.student-checkbox')[0];
                if (checkbox) {
                    checkbox.checked = select;
                }
            });
            
            updateSelectionDisplay();
        }

        // Select all students
        function selectAll() {
            const allIndices = dataTable.rows().indexes().toArray();
            allIndices.forEach(index => selectedStudentIndices.add(index));
            
            // Update checkboxes
            dataTable.rows().every(function() {
                const checkbox = $(this.node()).find('.student-checkbox')[0];
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
            
            document.getElementById('selectAllCheckbox').checked = true;
            updateSelectionDisplay();
        }

        // Deselect all students
        function deselectAll() {
            selectedStudentIndices.clear();
            
            // Update checkboxes
            dataTable.rows().every(function() {
                const checkbox = $(this.node()).find('.student-checkbox')[0];
                if (checkbox) {
                    checkbox.checked = false;
                }
            });
            
            document.getElementById('selectAllCheckbox').checked = false;
            updateSelectionDisplay();
        }

        // Update selection display
        function updateSelectionDisplay() {
            const selectedCount = selectedStudentIndices.size;
            document.getElementById('selectedCount').textContent = selectedCount;
            
            if (selectedCount > 0) {
                document.getElementById('selectionControls').style.display = 'block';
                document.getElementById('emailTemplatesBottom').style.display = 'block';
            } else {
                document.getElementById('selectionControls').style.display = 'none';
                document.getElementById('emailTemplatesBottom').style.display = 'none';
            }
        }

        // Update select all checkbox
        function updateSelectAllCheckbox() {
            const visibleIndices = dataTable.rows({ search: 'applied' }).indexes().toArray();
            const allVisibleSelected = visibleIndices.length > 0 && 
                                     visibleIndices.every(index => selectedStudentIndices.has(index));
            document.getElementById('selectAllCheckbox').checked = allVisibleSelected;
        }

        // Get selected students
        function getSelectedStudents() {
            return Array.from(selectedStudentIndices).map(index => allStudents[index]);
        }

        // Load CSV from GitHub
        async function loadCSVData() {
            if (!isLoggedIn) return;
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('dataStatus').textContent = 'Loading...';
            document.getElementById('noResultsMessage').style.display = 'none';
            disableExportButtons();
            
            try {
                // Your CSV file URL on GitHub
                const csvUrl = 'https://raw.githubusercontent.com/dineshkute90/pccoe_fy_contact_details/main/contact_testing_csv.csv';
                
                const response = await fetch(csvUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: false,
                    complete: function(results) {
                        if (results.errors.length > 0) {
                            console.warn('CSV parsing errors:', results.errors);
                        }
                        
                        processCSVData(results.data);
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('dataStatus').textContent = 'Loaded';
                        document.getElementById('noResultsMessage').style.display = 'block';
                        enableExportButtons();
                    },
                    error: function(error) {
                        console.error('CSV parsing error:', error);
                        document.getElementById('dataStatus').textContent = 'Error';
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('noResultsMessage').style.display = 'block';
                        disableExportButtons();
                        showCopySuccess('Error loading CSV file. Please check console for details.', 'error');
                    }
                });
            } catch (error) {
                console.error('Failed to fetch CSV:', error);
                document.getElementById('dataStatus').textContent = 'Failed';
                document.getElementById('loading').style.display = 'none';
                document.getElementById('noResultsMessage').style.display = 'block';
                disableExportButtons();
                showCopySuccess('Failed to load CSV file. Please check if the file exists.', 'error');
            }
        }

        // Process CSV data
        function processCSVData(data) {
            allStudents = [];
            
            // Check if data is empty
            if (!data || data.length === 0) {
                console.error('No data found in CSV');
                showCopySuccess('No data found in CSV file', 'error');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('noResultsMessage').style.display = 'block';
                disableExportButtons();
                return;
            }
            
            console.log('Total records found in CSV:', data.length);
            
            data.forEach((row, index) => {
                // Map CSV columns to our data structure
                const student = {
                    sr_no: row['Sr. No.'] || row['sr_no'] || row['Sr No'] || index + 1,
                    offering_year: row['Offering Year'] || row['offering_year'] || row['Offering_Year'] || '2022-2025',
                    prn: row['PRN'] || row['prn'] || row['PRN Number'] || '',
                    name: row['Student Name'] || row['name'] || row['Student_Name'] || row['Name'] || '',
                    student_mobile: row['Student Mobile Number'] || row['student_mobile'] || row['Student Mobile'] || row['Student_Mobile'] || row['Mobile'] || '',
                    parent_mobile: row['Parent Mobile Number'] || row['parent_mobile'] || row['Parent Mobile'] || row['Parent_Mobile'] || row['Parent Phone'] || '',
                    email: row['Student Email ID'] || row['email'] || row['Student Email'] || row['Student_Email'] || row['Email'] || ''
                };
                
                // Only add student if they have at least a PRN or Name
                if (student.prn || student.name) {
                    allStudents.push(student);
                }
            });
            
            console.log('Processed students:', allStudents.length);
            
            // Clear selection
            selectedStudentIndices.clear();
            
            // Initialize DataTable with the data
            initDataTable(allStudents);
            
            // Force update of total count
            updateTotalCount();
            updateExportCount();
            enableExportButtons();
        }

        // Parse PRN input with multiple separators
        function parsePRNInput(input) {
            if (!input) return [];
            
            // Replace various separators with comma
            let normalized = input
                .replace(/;/g, ',')   // Replace semicolons with commas
                .replace(/\t/g, ',')  // Replace tabs with commas
                .replace(/\n/g, ',')  // Replace new lines with commas
                .replace(/\s+/g, ','); // Replace multiple spaces with comma
            
            // Split by comma and clean up
            return normalized
                .split(',')
                .map(prn => prn.trim())
                .filter(prn => prn.length > 0)
                .filter((prn, index, self) => self.indexOf(prn) === index); // Remove duplicates
        }

        // Main search function
        function searchTable() {
            const prnSearch = document.getElementById('searchPRN').value.trim();
            const nameSearch = document.getElementById('searchName').value.trim();
            const filterColumn = document.getElementById('filterColumn').value;
            
            // Clear multi-PRN search
            document.getElementById('multiPRNSearch').value = '';
            document.getElementById('prnBadgesContainer').style.display = 'none';
            
            if (!dataTable) return;
            
            // Reset search
            dataTable.search('').draw();
            
            if (!prnSearch && !nameSearch) {
                // No search terms, show all data initially
                clearSearchResults();
                return;
            }
            
            // Store search criteria for display
            let searchCriteria = '';
            if (prnSearch) searchCriteria = `PRN: ${prnSearch}`;
            if (nameSearch) searchCriteria = searchCriteria ? `${searchCriteria}, Name: ${nameSearch}` : `Name: ${nameSearch}`;
            lastSearchCriteria = searchCriteria;
            
            // Custom filtering
            $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                if (settings.nTable.id !== 'studentTable') return true;
                
                const student = allStudents[dataIndex];
                if (!student) return false;
                
                const studentPRN = (student.prn || '').toLowerCase();
                const studentName = (student.name || '').toLowerCase();
                const studentMobile = (student.student_mobile || '').toLowerCase();
                const parentMobile = (student.parent_mobile || '').toLowerCase();
                const studentEmail = (student.email || '').toLowerCase();
                
                if (filterColumn === 'all') {
                    // Search in all columns
                    const searchTerm = (prnSearch || nameSearch).toLowerCase();
                    return (
                        studentPRN.includes(searchTerm) ||
                        studentName.includes(searchTerm) ||
                        studentMobile.includes(searchTerm) ||
                        parentMobile.includes(searchTerm) ||
                        studentEmail.includes(searchTerm)
                    );
                } else {
                    // Search in specific column
                    const searchTerm = (filterColumn === '1' ? prnSearch : nameSearch).toLowerCase();
                    if (!searchTerm) return true;
                    
                    switch(filterColumn) {
                        case '1': return studentPRN.includes(searchTerm);
                        case '2': return studentName.includes(searchTerm);
                        case '3': return studentMobile.includes(searchTerm);
                        case '4': return parentMobile.includes(searchTerm);
                        case '5': return studentEmail.includes(searchTerm);
                        default: return true;
                    }
                }
            });
            
            dataTable.draw();
            
            // Remove the custom filter function
            $.fn.dataTable.ext.search.pop();
            
            // Update search results
            updateCurrentSearchResults();
            updateSearchResultsDisplay();
            
            // Show/hide appropriate elements
            const resultsCount = currentSearchResults.length;
            if (resultsCount > 0) {
                document.getElementById('searchResultsHeader').style.display = 'flex';
                document.getElementById('noResultsMessage').style.display = 'none';
            } else {
                document.getElementById('searchResultsHeader').style.display = 'none';
                document.getElementById('noResultsMessage').style.display = 'block';
                document.getElementById('noResultsMessage').innerHTML = `
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5>No Results Found</h5>
                    <p class="text-muted">No students found matching: <strong>${lastSearchCriteria}</strong></p>
                    <p class="text-muted small">Please try different search criteria.</p>
                `;
            }
        }

        // Search multiple PRNs
        function searchMultiplePRNs() {
            const multiPRNInput = document.getElementById('multiPRNSearch').value.trim();
            
            // Clear single search fields
            document.getElementById('searchPRN').value = '';
            document.getElementById('searchName').value = '';
            document.getElementById('filterColumn').value = 'all';
            
            if (!dataTable) return;
            
            if (!multiPRNInput) {
                // If no PRNs, clear results
                clearSearchResults();
                return;
            }
            
            // Parse PRNs using the enhanced parser
            const prnList = parsePRNInput(multiPRNInput);
            
            if (prnList.length === 0) {
                showCopySuccess('No valid PRNs found in input. Please check your input.', 'error');
                return;
            }
            
            // Store search criteria for display
            lastSearchCriteria = `${prnList.length} PRN(s): ${prnList.slice(0, 5).join(', ')}${prnList.length > 5 ? '...' : ''}`;
            
            // Display PRN badges (show first 10 only to avoid clutter)
            const badgesContainer = document.getElementById('prnBadges');
            badgesContainer.innerHTML = '';
            
            const displayPrns = prnList.slice(0, 10);
            displayPrns.forEach(prn => {
                const badge = document.createElement('span');
                badge.className = 'prn-badge';
                badge.textContent = prn;
                badgesContainer.appendChild(badge);
            });
            
            if (prnList.length > 10) {
                const moreBadge = document.createElement('span');
                moreBadge.className = 'prn-badge';
                moreBadge.textContent = `+${prnList.length - 10} more`;
                moreBadge.style.backgroundColor = '#ff9800';
                moreBadge.style.color = '#1a237e';
                badgesContainer.appendChild(moreBadge);
            }
            
            document.getElementById('prnBadgesContainer').style.display = 'block';
            
            // Custom filtering for multiple PRNs
            $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                if (settings.nTable.id !== 'studentTable') return true;
                
                const student = allStudents[dataIndex];
                if (!student) return false;
                
                const studentPRN = (student.prn || '').toLowerCase();
                
                // Check if this student's PRN matches any in our list
                for (const searchPRN of prnList) {
                    if (studentPRN === searchPRN.toLowerCase()) {
                        return true;
                    }
                }
                
                return false;
            });
            
            dataTable.draw();
            
            // Remove the custom filter function
            $.fn.dataTable.ext.search.pop();
            
            // Update search results
            updateCurrentSearchResults();
            updateSearchResultsDisplay();
            
            // Show/hide appropriate elements
            const resultsCount = currentSearchResults.length;
            if (resultsCount > 0) {
                document.getElementById('searchResultsHeader').style.display = 'flex';
                document.getElementById('noResultsMessage').style.display = 'none';
                showCopySuccess(`Found ${resultsCount} student(s) matching ${prnList.length} PRN(s)`, 'success');
            } else {
                document.getElementById('searchResultsHeader').style.display = 'none';
                document.getElementById('noResultsMessage').style.display = 'block';
                document.getElementById('noResultsMessage').innerHTML = `
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5>No Results Found</h5>
                    <p class="text-muted">No students found matching the ${prnList.length} PRN(s) provided.</p>
                    <p class="text-muted small">Please check the PRN numbers and try again.</p>
                `;
                showCopySuccess(`No students found for the ${prnList.length} PRN(s) provided`, 'error');
            }
        }

        // Clear all search
        function clearSearch() {
            // Clear all search fields
            document.getElementById('searchPRN').value = '';
            document.getElementById('searchName').value = '';
            document.getElementById('multiPRNSearch').value = '';
            document.getElementById('filterColumn').value = 'all';
            
            // Hide PRN badges
            document.getElementById('prnBadgesContainer').style.display = 'none';
            
            // Clear search results
            clearSearchResults();
        }

        // Clear search results display
        function clearSearchResults() {
            if (dataTable) {
                dataTable.search('').draw();
                currentSearchResults = [];
                updateCurrentSearchResults();
                document.getElementById('searchResultsHeader').style.display = 'none';
                document.getElementById('noResultsMessage').style.display = 'block';
                document.getElementById('noResultsMessage').innerHTML = `
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5>Search Students</h5>
                    <p class="text-muted">Enter search criteria above to find students.</p>
                    <p class="text-muted small">Search results will be displayed here and available for export.</p>
                `;
            }
        }

        // Update current search results array
        function updateCurrentSearchResults() {
            if (!dataTable) return;
            
            const filteredIndices = dataTable.rows({ search: 'applied' }).indexes().toArray();
            currentSearchResults = filteredIndices.map(index => allStudents[index]);
            updateExportCount();
        }

        // Update search results display
        function updateSearchResultsDisplay() {
            const resultsCount = currentSearchResults.length;
            document.getElementById('resultsCount').textContent = resultsCount;
            document.getElementById('searchResults').textContent = resultsCount;
            
            // Update search criteria display
            if (lastSearchCriteria) {
                document.getElementById('searchCriteria').textContent = `(${lastSearchCriteria})`;
            } else {
                document.getElementById('searchCriteria').textContent = '';
            }
        }

        // Update export count
        function updateExportCount() {
            if (!dataTable) {
                document.getElementById('exportCount').textContent = '0';
                return;
            }
            
            const filteredCount = dataTable.rows({ search: 'applied' }).count();
            document.getElementById('exportCount').textContent = filteredCount;
        }

        // Disable export buttons
        function disableExportButtons() {
            document.getElementById('exportSearchBtn').disabled = true;
            document.getElementById('exportHeaderBtn').disabled = true;
        }

        // Enable export buttons
        function enableExportButtons() {
            document.getElementById('exportSearchBtn').disabled = false;
            document.getElementById('exportHeaderBtn').disabled = false;
        }

        // Export search results
        function exportSearchResults() {
            if (!isLoggedIn) {
                showLogin();
                return;
            }
            
            if (currentSearchResults.length === 0) {
                showCopySuccess('No search results to export. Please search first.', 'error');
                return;
            }
            
            const includeTimestamp = document.getElementById('includeTimestamp').checked;
            const format = document.getElementById('exportFormat').value;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            
            let fileName = 'PCCOE_Search_Results';
            
            if (includeTimestamp) {
                fileName += `_${timestamp}`;
            }
            
            fileName += `.${format}`;
            
            // Prepare worksheet data
            const worksheetData = [
                ['PCCOE Student Directory - Department of Applied Sciences & Humanities'],
                ['Exported on: ' + new Date().toLocaleString('en-IN')],
                ['Search Criteria: ' + (lastSearchCriteria || 'All Students')],
                ['Total Records: ' + currentSearchResults.length],
                [''], // Empty row
                ['Sr. No.', 'Offering Year', 'PRN', 'Student Name', 'Student Mobile', 'Parent Mobile', 'Email ID']
            ];
            
            // Add student data
            currentSearchResults.forEach((student, index) => {
                worksheetData.push([
                    index + 1,
                    student.offering_year || '2022-2025',
                    student.prn || '',
                    student.name || '',
                    student.student_mobile || '',
                    student.parent_mobile || '',
                    student.email || ''
                ]);
            });
            
            // Create workbook
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
            
            // Set column widths
            const colWidths = [
                { wch: 8 },  // Sr. No.
                { wch: 15 }, // Offering Year
                { wch: 12 }, // PRN
                { wch: 25 }, // Student Name
                { wch: 15 }, // Student Mobile
                { wch: 15 }, // Parent Mobile
                { wch: 30 }  // Email ID
            ];
            worksheet['!cols'] = colWidths;
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Students');
            
            try {
                if (format === 'xlsx') {
                    XLSX.writeFile(workbook, fileName);
                } else {
                    // For CSV, convert to CSV string
                    const csv = XLSX.utils.sheet_to_csv(worksheet);
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', fileName);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }
                
                showCopySuccess(`Exported ${currentSearchResults.length} search results to ${fileName}`, 'success');
            } catch (error) {
                console.error('Export error:', error);
                showCopySuccess('Error exporting file. Please try again.', 'error');
            }
        }

        // Email sending functions
        function sendSingleEmail(email, studentName, prn) {
            if (!isLoggedIn) {
                showLogin();
                return;
            }
            
            if (!email) {
                showCopySuccess('No email address available for this student', 'error');
                return;
            }
            
            // Open Gmail with blank email
            const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(email)}&su=${encodeURIComponent('Message from PCCOE')}`;
            window.open(gmailUrl, '_blank');
        }

        function sendTemplateEmail(email, studentName, prn, templateKey) {
            if (!isLoggedIn) {
                showLogin();
                return;
            }
            
            if (!email) {
                showCopySuccess('No email address available for this student', 'error');
                return;
            }
            
            const template = EMAIL_TEMPLATES[templateKey];
            if (!template) {
                showCopySuccess('Template not found', 'error');
                return;
            }
            
            // Replace placeholders in template
            let subject = template.subject;
            let body = template.body;
            
            subject = subject.replace('[Student Name]', studentName);
            body = body.replace(/\[Student Name\]/g, studentName)
                       .replace(/\[PRN\]/g, prn);
            
            // Open Gmail with pre-filled draft
            const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(email)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(gmailUrl, '_blank');
            
            showCopySuccess(`Opening Gmail for ${studentName} with ${template.name}`, 'success');
        }
// Function to open multiple emails with better handling
function openMultipleEmails(students, template, delay = 3000) {
    let count = 0;
    const total = students.length;
    
    function openEmail(index) {
        if (index >= total) {
            showCopySuccess(`Successfully opened ${count} email draft(s) for selected students.`, 'success');
            return;
        }
        
        const student = students[index];
        
        // Prepare email
        let subject = template.subject;
        let body = template.body;
        
        subject = subject.replace('[Student Name]', student.name || 'Student');
        body = body.replace(/\[Student Name\]/g, student.name || 'Student')
                   .replace(/\[PRN\]/g, student.prn || '')
                   .replace(/\[Attendance\]/g, 'To be updated');
        
        // Update progress message
        showCopySuccess(`Opening email ${index + 1}/${total} for ${student.name}...`, 'success');
        
        // Create the Gmail URL
        const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(student.email)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        
        // Try to open the email
        try {
            const newWindow = window.open(gmailUrl, `gmail_${Date.now()}_${index}`);
            
            if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                showCopySuccess(`Popup blocked for ${student.name}. Please allow popups and try again.`, 'error');
            } else {
                count++;
            }
            
            // Wait and open next email
            setTimeout(() => {
                openEmail(index + 1);
            }, delay);
            
        } catch (error) {
            showCopySuccess(`Error opening email for ${student.name}: ${error.message}`, 'error');
            setTimeout(() => openEmail(index + 1), delay);
        }
    }
    
    openEmail(0);
}
        // Send template email to selected students
        function sendSelectedTemplateEmail(templateKey) {
    const selectedStudents = getSelectedStudents();
    
    if (selectedStudents.length === 0) {
        showCopySuccess('Please select at least one student', 'error');
        return;
    }
    
    const template = EMAIL_TEMPLATES[templateKey];
    if (!template) {
        showCopySuccess('Template not found', 'error');
        return;
    }
    
    // Filter students with valid email
    const studentsWithEmail = selectedStudents.filter(student => 
        student.email && student.email.includes('@')
    );
    
    if (studentsWithEmail.length === 0) {
        showCopySuccess('No selected students have valid email addresses', 'error');
        return;
    }
    
    // Show sending in progress
    showCopySuccess(`Preparing emails for ${studentsWithEmail.length} student(s)...`, 'success');
    
   // Send emails one by one with proper delay
let sentCount = 0;

function sendNextEmail(index) {
    if (index >= studentsWithEmail.length) {
        // All emails sent
        showCopySuccess(`Opened Gmail for ${sentCount} student(s). Check your tabs.`, 'success');
        return;
    }
    
    const student = studentsWithEmail[index];
    
    // Prepare personalized email
    let subject = template.subject;
    let body = template.body;
    
    subject = subject.replace('[Student Name]', student.name || 'Student');
    body = body.replace(/\[Student Name\]/g, student.name || 'Student')
               .replace(/\[PRN\]/g, student.prn || '')
               .replace(/\[Attendance\]/g, 'To be updated');
    
    // Show progress
    if (sentCount === 0) {
        showCopySuccess(`Opening email for ${student.name}...`, 'success');
    } else {
        showCopySuccess(`Opened ${sentCount} email(s). Now opening for ${student.name}...`, 'success');
    }
    
    // Open Gmail in new tab with a slight delay to ensure the previous window is loaded
    setTimeout(() => {
        const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(student.email)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        
        // Open in a new window with specific features to avoid popup blocking
        const mailWindow = window.open(gmailUrl, `gmail_${Date.now()}_${index}`, 'width=800,height=600,scrollbars=yes');
        
        // Check if window was opened successfully
        if (!mailWindow || mailWindow.closed) {
            showCopySuccess(`Could not open email for ${student.name}. Popup might be blocked.`, 'error');
        }
        
        sentCount++;
        
        // Send next email after delay (3 seconds to avoid popup blocking)
        setTimeout(() => sendNextEmail(index + 1), 3000);
    }, 500);
}

// Start sending emails
sendNextEmail(0);
}
        // Bulk email functions
        function openBulkEmailModal() {
            const selectedStudents = getSelectedStudents();
            
            if (selectedStudents.length === 0) {
                showCopySuccess('Please select at least one student', 'error');
                return;
            }
            
            // Update selected students count
            document.getElementById('selectedStudentsCount').textContent = selectedStudents.length;
            
            // Update email list
            const emailList = document.getElementById('selectedStudentsEmails');
            emailList.innerHTML = '';
            
            selectedStudents.slice(0, 10).forEach(student => {
                const emailItem = document.createElement('div');
                emailItem.className = 'text-truncate';
                emailItem.title = `${student.name} - ${student.email}`;
                emailItem.textContent = `${student.name}: ${student.email}`;
                emailList.appendChild(emailItem);
            });
            
            if (selectedStudents.length > 10) {
                const moreItem = document.createElement('div');
                moreItem.className = 'text-muted';
                moreItem.textContent = `...and ${selectedStudents.length - 10} more students`;
                emailList.appendChild(moreItem);
            }
            
            // Load templates
            const templateList = document.getElementById('templateList');
            templateList.innerHTML = '';
            
            Object.keys(EMAIL_TEMPLATES).forEach(key => {
                const template = EMAIL_TEMPLATES[key];
                const templateDiv = document.createElement('div');
                templateDiv.className = 'template-item';
                templateDiv.dataset.templateKey = key;
                templateDiv.onclick = function() {
                    // Remove active class from all
                    document.querySelectorAll('.template-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    // Add active to clicked
                    this.classList.add('active');
                    // Show preview
                    showTemplatePreview(key);
                };
                
                templateDiv.innerHTML = `
                    <div class="template-subject">${template.name}</div>
                    <div class="template-content">${template.subject}</div>
                `;
                
                templateList.appendChild(templateDiv);
            });
            
            // Show first template by default
            if (Object.keys(EMAIL_TEMPLATES).length > 0) {
                const firstKey = Object.keys(EMAIL_TEMPLATES)[0];
                document.querySelector(`[data-template-key="${firstKey}"]`).classList.add('active');
                showTemplatePreview(firstKey);
            }
            
            // Reset progress
            document.getElementById('emailProgress').style.display = 'none';
            document.getElementById('sendBulkEmailsBtn').disabled = false;
            
            // Show modal
            const bulkEmailModal = new bootstrap.Modal(document.getElementById('bulkEmailModal'));
            bulkEmailModal.show();
        }

        function showTemplatePreview(templateKey) {
            const template = EMAIL_TEMPLATES[templateKey];
            const previewDiv = document.getElementById('templatePreview');
            
            previewDiv.innerHTML = `
                <div class="template-subject">Subject: ${template.subject}</div>
                <div class="template-content">${template.body.replace(/\n/g, '<br>')}</div>
            `;
        }

        function sendBulkEmails() {
            const activeTemplate = document.querySelector('.template-item.active');
            if (!activeTemplate) {
                showCopySuccess('Please select a template first', 'error');
                return;
            }
            
            const templateKey = activeTemplate.dataset.templateKey;
            const template = EMAIL_TEMPLATES[templateKey];
            
            // Disable send button and show progress
            const sendBtn = document.getElementById('sendBulkEmailsBtn');
            sendBtn.disabled = true;
            
            const progressDiv = document.getElementById('emailProgress');
            const progressBar = document.getElementById('emailProgressBar');
            const progressText = document.getElementById('emailProgressText');
            
            progressDiv.style.display = 'block';
            
            // Get selected students
            const selectedStudents = getSelectedStudents();
            
            // Filter students with valid email
            const studentsWithEmail = selectedStudents.filter(student => 
                student.email && student.email.includes('@')
            );
            
            if (studentsWithEmail.length === 0) {
                showCopySuccess('No selected students with valid email addresses found', 'error');
                sendBtn.disabled = false;
                progressDiv.style.display = 'none';
                return;
            }
            
            let sentCount = 0;
            const totalCount = studentsWithEmail.length;
            
            progressText.textContent = `${sentCount}/${totalCount}`;
            progressBar.style.width = '0%';
            
           // Filter students with valid email
const studentsWithEmail = selectedStudents.filter(student => 
    student.email && student.email.includes('@')
);

if (studentsWithEmail.length === 0) {
    showCopySuccess('No selected students have valid email addresses', 'error');
    return;
}

// Show warning about popups
showCopySuccess(`Opening ${studentsWithEmail.length} email draft(s). Please allow popups and check your browser tabs.`, 'warning');

// Use the new function to open multiple emails
openMultipleEmails(studentsWithEmail, template, 3000);
                
                // Prepare personalized email
                let subject = template.subject;
                let body = template.body;
                
                subject = subject.replace('[Student Name]', student.name || 'Student');
                body = body.replace(/\[Student Name\]/g, student.name || 'Student')
                           .replace(/\[PRN\]/g, student.prn || '')
                           .replace(/\[Attendance\]/g, 'To be updated');
                
                // Open Gmail in new tab
                const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(student.email)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.open(gmailUrl, '_blank');
                
                sentCount++;
                
                // Update progress
                progressText.textContent = `${sentCount}/${totalCount}`;
                progressBar.style.width = `${(sentCount / totalCount) * 100}%`;
                
                // Send next email after delay (to avoid popup blocking)
                setTimeout(() => sendNextEmail(index + 1), 1000);
            }
            
            // Start sending emails
            sendNextEmail(0);
        }

        // ADMIN FUNCTIONS

        // Show all students (admin only)
        function showAllStudents() {
            if (!isAdmin) {
                showCopySuccess('Admin access required', 'error');
                return;
            }
            
            clearSearch();
            document.getElementById('searchResultsHeader').style.display = 'flex';
            document.getElementById('resultsCount').textContent = allStudents.length;
            document.getElementById('searchCriteria').textContent = '(All Students)';
            document.getElementById('noResultsMessage').style.display = 'none';
            
            showCopySuccess(`Displaying all ${allStudents.length} students`, 'success');
        }

        // Export entire database (admin only)
        function exportAllData() {
            if (!isAdmin) {
                showCopySuccess('Admin access required', 'error');
                return;
            }
            
            const includeTimestamp = document.getElementById('includeTimestamp').checked;
            const format = document.getElementById('exportFormat').value;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            
            let fileName = 'PCCOE_Complete_Database';
            
            if (includeTimestamp) {
                fileName += `_${timestamp}`;
            }
            
            fileName += `.${format}`;
            
            // Prepare worksheet data
            const worksheetData = [
                ['PCCOE Student Directory - Department of Applied Sciences & Humanities'],
                ['Exported on: ' + new Date().toLocaleString('en-IN')],
                ['Complete Database Export - Admin Access'],
                ['Total Records: ' + allStudents.length],
                [''], // Empty row
                ['Sr. No.', 'Offering Year', 'PRN', 'Student Name', 'Student Mobile', 'Parent Mobile', 'Email ID']
            ];
            
            // Add all student data
            allStudents.forEach((student, index) => {
                worksheetData.push([
                    index + 1,
                    student.offering_year || '2022-2025',
                    student.prn || '',
                    student.name || '',
                    student.student_mobile || '',
                    student.parent_mobile || '',
                    student.email || ''
                ]);
            });
            
            // Create workbook
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
            
            // Set column widths
            const colWidths = [
                { wch: 8 },  // Sr. No.
                { wch: 15 }, // Offering Year
                { wch: 12 }, // PRN
                { wch: 25 }, // Student Name
                { wch: 15 }, // Student Mobile
                { wch: 15 }, // Parent Mobile
                { wch: 30 }  // Email ID
            ];
            worksheet['!cols'] = colWidths;
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Students');
            
            try {
                if (format === 'xlsx') {
                    XLSX.writeFile(workbook, fileName);
                } else {
                    // For CSV, convert to CSV string
                    const csv = XLSX.utils.sheet_to_csv(worksheet);
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', fileName);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }
                
                showCopySuccess(`Exported complete database (${allStudents.length} records) to ${fileName}`, 'success');
            } catch (error) {
                console.error('Export error:', error);
                showCopySuccess('Error exporting file. Please try again.', 'error');
            }
        }

        // Show add student modal
        function showAddStudentModal() {
            if (!isAdmin) {
                showCopySuccess('Admin access required', 'error');
                return;
            }
            
            // Clear form
            document.getElementById('addPRN').value = '';
            document.getElementById('addName').value = '';
            document.getElementById('addOfferingYear').value = '2025-26';
            document.getElementById('addStudentMobile').value = '';
            document.getElementById('addParentMobile').value = '';
            document.getElementById('addEmail').value = '';
            
            addModal.show();
        }

        // Add new student
        function addNewStudent() {
            if (!isAdmin) {
                showCopySuccess('Admin access required', 'error');
                return;
            }
            
            const prn = document.getElementById('addPRN').value.trim();
            const name = document.getElementById('addName').value.trim();
            const offeringYear = document.getElementById('addOfferingYear').value.trim() || '2025-26';
            const studentMobile = document.getElementById('addStudentMobile').value.trim();
            const parentMobile = document.getElementById('addParentMobile').value.trim() || 'NA';
            const email = document.getElementById('addEmail').value.trim();
            
            // Validation
            if (!prn || !name || !studentMobile || !email) {
                showCopySuccess('Please fill all required fields (PRN, Name, Mobile, Email)', 'error');
                return;
            }
            
            // Check if PRN already exists
            if (allStudents.some(student => student.prn === prn)) {
                showCopySuccess(`PRN ${prn} already exists. Please use a different PRN.`, 'error');
                return;
            }
            
            // Create new student object
            const newStudent = {
                sr_no: allStudents.length + 1,
                offering_year: offeringYear,
                prn: prn,
                name: name,
                student_mobile: studentMobile,
                parent_mobile: parentMobile,
                email: email
            };
            
            // Add to array
            allStudents.push(newStudent);
            
            // Update DataTable
            dataTable.row.add(newStudent).draw();
            
            // Update statistics
            updateTotalCount();
            
            // Close modal
            addModal.hide();
            
            showCopySuccess(`Student ${name} (${prn}) added successfully`, 'success');
        }

        // Edit student
        function editStudent(index) {
            if (!isAdmin) {
                showCopySuccess('Admin access required', 'error');
                return;
            }
            
            const student = allStudents[index];
            
            // Fill form with student data
            document.getElementById('editStudentIndex').value = index;
            document.getElementById('editPRN').value = student.prn || '';
            document.getElementById('editName').value = student.name || '';
            document.getElementById('editOfferingYear').value = student.offering_year || '2025-26';
            document.getElementById('editStudentMobile').value = student.student_mobile || '';
            document.getElementById('editParentMobile').value = student.parent_mobile || '';
            document.getElementById('editEmail').value = student.email || '';
            
            editModal.show();
        }

        // Save student changes
        function saveStudentChanges() {
            if (!isAdmin) {
                showCopySuccess('Admin access required', 'error');
                return;
            }
            
            const index = parseInt(document.getElementById('editStudentIndex').value);
            const student = allStudents[index];
            
            // Get updated values
            const updatedStudent = {
                sr_no: student.sr_no,
                offering_year: document.getElementById('editOfferingYear').value.trim() || '2025-26',
                prn: document.getElementById('editPRN').value.trim(),
                name: document.getElementById('editName').value.trim(),
                student_mobile: document.getElementById('editStudentMobile').value.trim(),
                parent_mobile: document.getElementById('editParentMobile').value.trim() || 'NA',
                email: document.getElementById('editEmail').value.trim()
            };
            
            // Validation
            if (!updatedStudent.prn || !updatedStudent.name || !updatedStudent.student_mobile || !updatedStudent.email) {
                showCopySuccess('Please fill all required fields (PRN, Name, Mobile, Email)', 'error');
                return;
            }
            
            // Update in array
            allStudents[index] = updatedStudent;
            
            // Update DataTable
            dataTable.row(index).data(updatedStudent).draw();
            
            // Close modal
            editModal.hide();
            
            showCopySuccess(`Student ${updatedStudent.name} (${updatedStudent.prn}) updated successfully`, 'success');
        }

        // Delete student from table
        function deleteStudent(index) {
            if (!isAdmin) {
                showCopySuccess('Admin access required', 'error');
                return;
            }
            
            const student = allStudents[index];
            
            if (confirm(`Are you sure you want to delete student ${student.name} (${student.prn})?`)) {
                // Remove from array
                allStudents.splice(index, 1);
                
                // Remove from selection if selected
                selectedStudentIndices.delete(index);
                
                // Update indices in selectedStudentIndices for students after the deleted one
                const newSelectedIndices = new Set();
                selectedStudentIndices.forEach(selectedIndex => {
                    if (selectedIndex > index) {
                        newSelectedIndices.add(selectedIndex - 1);
                    } else if (selectedIndex < index) {
                        newSelectedIndices.add(selectedIndex);
                    }
                });
                selectedStudentIndices = newSelectedIndices;
                
                // Update DataTable
                dataTable.row(index).remove().draw();
                
                // Update statistics
                updateTotalCount();
                updateSelectionDisplay();
                
                showCopySuccess(`Student ${student.name} (${student.prn}) deleted successfully`, 'success');
            }
        }

        // Delete current student from modal
        function deleteCurrentStudent() {
            if (!isAdmin) {
                showCopySuccess('Admin access required', 'error');
                return;
            }
            
            const index = parseInt(document.getElementById('editStudentIndex').value);
            deleteStudent(index);
            editModal.hide();
        }

        // Update total count
        function updateTotalCount() {
            const totalCount = allStudents.length;
            document.getElementById('totalStudents').textContent = totalCount;
        }

        // Generic copy to clipboard function
        function copyToClipboard(text, label) {
            if (!isLoggedIn) {
                showLogin();
                return;
            }
            
            navigator.clipboard.writeText(text).then(() => {
                showCopySuccess(`${label} copied to clipboard`);
            }).catch(err => {
                console.error('Failed to copy:', err);
                // Fallback method
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showCopySuccess(`${label} copied to clipboard`);
            });
        }

        // Show copy success message
        function showCopySuccess(message, type = 'success') {
            const bgColor = type === 'error' ? '#dc3545' : '#28a745';
            
            // Create a temporary notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 10000;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                animation: fadeInOut 2s ease-in-out;
                display: flex;
                align-items: center;
                gap: 10px;
                max-width: 300px;
            `;
            
            // Add CSS for animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeInOut {
                    0% { opacity: 0; transform: translateY(-20px); }
                    10% { opacity: 1; transform: translateY(0); }
                    90% { opacity: 1; transform: translateY(0); }
                    100% { opacity: 0; transform: translateY(-20px); }
                }
            `;
            document.head.appendChild(style);
            
            notification.innerHTML = `
                <i class="fas ${type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            
            // Remove after 2 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    document.body.removeChild(notification);
                }
                if (style.parentNode) {
                    document.head.removeChild(style);
                }
            }, 2000);
        }

        // Initialize on page load
        $(document).ready(function() {
            // Setup login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Check if user is already logged in
            checkLoginStatus();
            
            if (!isLoggedIn) {
                showLogin();
            }
            
            // Add enter key support for search
            $(document).on('keypress', '#searchPRN, #searchName, #multiPRNSearch', function(e) {
                if (e.which === 13 && isLoggedIn) {
                    if ($(this).attr('id') === 'multiPRNSearch') {
                        searchMultiplePRNs();
                    } else {
                        searchTable();
                    }
                }
            });
            
            // Auto-search after typing
            let searchTimer;
            $(document).on('keyup', '#searchPRN, #searchName', function() {
                if (isLoggedIn) {
                    clearTimeout(searchTimer);
                    searchTimer = setTimeout(searchTable, 300);
                }
            });
            
            // Auto-search for multi-PRN
            let multiPRNTimer;
            $(document).on('keyup', '#multiPRNSearch', function() {
                if (isLoggedIn) {
                    clearTimeout(multiPRNTimer);
                    multiPRNTimer = setTimeout(function() {
                        const input = document.getElementById('multiPRNSearch').value.trim();
                        if (input) {
                            searchMultiplePRNs();
                        }
                    }, 500);
                }
            });
            
            // Handle paste event for Excel data
            document.getElementById('multiPRNSearch').addEventListener('paste', function(e) {
                // Let the paste happen first
                setTimeout(() => {
                    // Auto-trigger search after paste
                    if (this.value.trim()) {
                        searchMultiplePRNs();
                    }
                }, 100);
            });
        });
    </script>
</body>
</html>
